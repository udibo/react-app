name: CI
on: [push]
jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: true
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Setup deno
        uses: denoland/setup-deno@main
        with:
          deno-version: v1.x
      - name: Check formatting and lint
        run: deno task check
      - name: Build
        run: deno task build
      - name: Run tests
        run: deno task test-coverage
      - name: Generate coverage
        run: deno task coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: cov.lcov
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
      - name: Pre-deploy cleanup
        run: |
          rm cov.lcov
          rm -rf cov
      - name: Upload to Deno Deploy
        uses: denoland/deployctl@v1
        with:
          project: 'udibo-react-app'
          root: './'
          entrypoint: './example/main.ts'
          import-map: './example/import_map.json'
      - name: Release info
        if: |
          github.repository == 'udibo/react_app' &&
          startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          echo "RELEASE_VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV
      - name: Release
        uses: softprops/action-gh-release@v1
        if: env.RELEASE_VERSION != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
